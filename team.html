<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MIGA Team Hub</title>
    <style>
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; background: #f0f2f5; }
        #sidebar { width: 250px; background: #1a73e8; color: white; padding: 20px; }
        #chat-container { flex: 1; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .msg { background: white; padding: 10px; border-radius: 10px; margin-bottom: 10px; max-width: 70%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .msg img { max-width: 100%; border-radius: 5px; margin-top: 5px; }
        #input-area { background: white; padding: 20px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        button { background: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .file-label { cursor: pointer; background: #eee; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>MIGA Team</h2>
    <div id="member-list">Loading members...</div>
</div>

<div id="chat-container">
    <div id="messages"></div>
    <div id="input-area">
        <label class="file-label">üìÅ<input type="file" id="fileInput" style="display:none"></label>
        <input type="text" id="msgInput" placeholder="Type a message or share a file...">
        <button id="sendBtn">Send</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Use your SAME config from index.html here
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "project--miga.firebaseapp.com",
        projectId: "project--miga",
        storageBucket: "project--miga.appspot.com",
        messagingSenderId: "YOUR_ID",
        appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const msgArea = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const fileInput = document.getElementById('fileInput');

    // 1. Load Real-time Chat
    const q = query(collection(db, "team_chats"), orderBy("timestamp", "asc"));
    onSnapshot(q, (snapshot) => {
        msgArea.innerHTML = '';
        snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement('div');
            div.className = 'msg';
            let content = `<strong>${data.user}</strong>: ${data.text}`;
            if(data.fileUrl) {
                if(data.type.includes('image')) content += `<br><img src="${data.fileUrl}">`;
                else content += `<br><a href="${data.fileUrl}" target="_blank">View Attachment</a>`;
            }
            div.innerHTML = content;
            msgArea.appendChild(div);
        });
        msgArea.scrollTop = msgArea.scrollHeight;
    });

    // 2. Send Function
    async function sendMessage(fileUrl = null, fileType = null) {
        if (!msgInput.value && !fileUrl) return;
        await addDoc(collection(db, "team_chats"), {
            user: "Team Member", // You can update this to show actual names later
            text: msgInput.value,
            fileUrl: fileUrl,
            type: fileType || 'text',
            timestamp: new Date()
        });
        msgInput.value = '';
    }

    document.getElementById('sendBtn').onclick = () => sendMessage();

    // 3. Handle File Uploads
    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const storageRef = ref(storage, 'team_files/' + file.name);
        alert("Uploading file...");
        const snapshot = await uploadBytes(storageRef, file);
        const url = await getDownloadURL(snapshot.ref);
        sendMessage(url, file.type);
    };
</script>
</body>
</html>
